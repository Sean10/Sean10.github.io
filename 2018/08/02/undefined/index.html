<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="之前在公司服务器上验证了好多次流程图，结果是被改过代码了可能，运行结果与原生CentOS镜像结果不同。被迫混淆了好久。">
<meta name="keywords" content="linux,rsyslog,systemd">
<meta property="og:type" content="article">
<meta property="og:title" content="rsyslog &amp; journald日志系统结构">
<meta property="og:url" content="https://sean10.github.io/2018/08/02/undefined/index.html">
<meta property="og:site_name" content="行路中.">
<meta property="og:description" content="之前在公司服务器上验证了好多次流程图，结果是被改过代码了可能，运行结果与原生CentOS镜像结果不同。被迫混淆了好久。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-10-08T15:11:42.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="rsyslog &amp; journald日志系统结构">
<meta name="twitter:description" content="之前在公司服务器上验证了好多次流程图，结果是被改过代码了可能，运行结果与原生CentOS镜像结果不同。被迫混淆了好久。">






  <link rel="canonical" href="https://sean10.github.io/2018/08/02/undefined/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>rsyslog & journald日志系统结构 | 行路中.</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">行路中.</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">脚踏实地</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sean10.github.io/2018/08/02/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sean10">
      <meta itemprop="description" content="笔记 随笔">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="行路中.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">rsyslog & journald日志系统结构
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-08-02 01:45:01" itemprop="dateCreated datePublished" datetime="2018-08-02T01:45:01+08:00">2018-08-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-10-08 23:11:42" itemprop="dateModified" datetime="2018-10-08T23:11:42+08:00">2018-10-08</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/pro/" itemprop="url" rel="index"><span itemprop="name">专业</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/02/undefined/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments: </span> <span class="post-comments-count valine-comment-count" data-xid="/2018/08/02/undefined/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/08/02/undefined/" class="leancloud_visitors" data-flag-title="rsyslog & journald日志系统结构">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views: </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">34k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">0:31</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>之前在公司服务器上验证了好多次流程图，结果是被改过代码了可能，运行结果与原生CentOS镜像结果不同。被迫混淆了好久。</p>
<a id="more"></a>
<h1 id="基本背景">基本背景</h1>
<h2 id="实验环境">实验环境</h2>
<ul>
<li>Centos 7.4</li>
<li>rsyslog 8.24</li>
<li>systemd环境</li>
</ul>
<h1 id="rsyslog与systemd-journald日志流向">rsyslog与systemd-journald日志流向</h1>
<!--![](http://10.192.44.64:5000/_uploads/photos/rsyslog_journald.png)-->
<p>目前来看，lsof只能查看该进程监听的socket,不显示它发送的socket。通过strace追踪，RecMsg会显示发送方的进程pid，从那里可以看到是哪个进程发送到自己监听的socket的信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># rsyslog</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># strace -T -ttt -f -p 35341</span></span><br><span class="line">strace: Process 35341 attached with 3 threads</span><br><span class="line">[pid 35343] 1532962871.699907 futex(0x559329e6e2ac, FUTEX_WAIT_PRIVATE, 23, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid 35342] 1532962871.699926 select(4, [3], NULL, NULL, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid 35341] 1532962871.699940 select(1, NULL, NULL, NULL, &#123;367, 871364&#125; &lt;unfinished ...&gt;</span><br><span class="line">[pid 35342] 1532962894.732966 &lt;... select resumed&gt; ) = 1 (<span class="keyword">in</span> [3]) &lt;23.033022&gt;</span><br><span class="line">[pid 35342] 1532962894.733015 recvmsg(3, &#123;msg_name(0)=NULL, msg_iov(1)=[&#123;<span class="string">"&lt;13&gt;Jul 30 11:01:34 root: newer"</span>, 8096&#125;], msg_controllen=64, [&#123;cmsg_len=32, cmsg_level=SOL_SOCKET, cmsg_type=0x1d /* SCM_??? */&#125;, &#123;cmsg_len=28, cmsg_level=SOL_SOCKET, cmsg_type=SCM_CREDENTIALS, &#123;pid=10247, uid=0, gid=0&#125;&#125;], msg_flags=0&#125;, MSG_DONTWAIT) = 31 &lt;0.000008&gt;</span><br><span class="line">[pid 35342] 1532962894.733070 futex(0x559329e6e2ac, FUTEX_WAKE_OP_PRIVATE, 1, 1, 0x559329e6e2a8, &#123;FUTEX_OP_SET, 0, FUTEX_OP_CMP_GT, 1&#125; &lt;unfinished ...&gt;</span><br><span class="line">[pid 35343] 1532962894.733094 &lt;... futex resumed&gt; ) = 0 &lt;23.033169&gt;</span><br><span class="line">[pid 35342] 1532962894.733098 &lt;... futex resumed&gt; ) = 1 &lt;0.000018&gt;</span><br><span class="line">[pid 35343] 1532962894.733110 futex(0x559329e6e0b0, FUTEX_WAIT_PRIVATE, 2, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid 35342] 1532962894.733116 futex(0x559329e6e0b0, FUTEX_WAKE_PRIVATE, 1 &lt;unfinished ...&gt;</span><br><span class="line">[pid 35343] 1532962894.733128 &lt;... futex resumed&gt; ) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000012&gt;</span><br><span class="line">[pid 35342] 1532962894.733140 &lt;... futex resumed&gt; ) = 0 &lt;0.000021&gt;</span><br><span class="line">[pid 35343] 1532962894.733154 futex(0x559329e6e0b0, FUTEX_WAKE_PRIVATE, 1 &lt;unfinished ...&gt;</span><br><span class="line">[pid 35342] 1532962894.733160 select(4, [3], NULL, NULL, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid 35343] 1532962894.733175 &lt;... futex resumed&gt; ) = 0 &lt;0.000016&gt;</span><br><span class="line">[pid 35343] 1532962894.733194 write(5, <span class="string">"Jul 30 11:01:34 localhost root: "</span>..., 38) = 38 &lt;0.000020&gt;</span><br><span class="line">[pid 35343] 1532962894.733234 futex(0x559329e6e2ac, FUTEX_WAIT_PRIVATE, 25, NULL</span><br><span class="line"></span><br><span class="line"><span class="comment"># systemd-journald</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># strace -ttt -f -p 10247</span></span><br><span class="line">strace: Process 10247 attached</span><br><span class="line">1532962887.731909 epoll_wait(7, [&#123;EPOLLIN, &#123;u32=3876856720, u64=94080840508304&#125;&#125;], 10, -1) = 1</span><br><span class="line">1532962894.732687 clock_gettime(CLOCK_BOOTTIME, &#123;246287, 470494988&#125;) = 0</span><br><span class="line">1532962894.732723 ioctl(5, FIONREAD, [31]) = 0</span><br><span class="line">1532962894.732755 recvmsg(5, &#123;msg_name(0)=0x7ffc9785fab0, msg_iov(1)=[&#123;<span class="string">"&lt;13&gt;Jul 30 11:01:34 root: newer"</span>, 24575&#125;], msg_controllen=136, [&#123;cmsg_len=32, cmsg_level=SOL_SOCKET, cmsg_type=0x1d /* SCM_??? */&#125;, &#123;cmsg_len=28, cmsg_level=SOL_SOCKET, cmsg_type=SCM_CREDENTIALS, &#123;pid=35455, uid=0, gid=0&#125;&#125;, &#123;cmsg_len=70, cmsg_level=SOL_SOCKET, cmsg_type=SCM_SECURITY, <span class="string">"unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023\0"</span>&#125;], msg_flags=MSG_CMSG_CLOEXEC&#125;, MSG_DONTWAIT|MSG_CMSG_CLOEXEC) = 31</span><br><span class="line">1532962894.732825 sendmsg(5, &#123;msg_name(29)=&#123;sa_family=AF_LOCAL, sun_path=<span class="string">"/run/systemd/journal/syslog"</span>&#125;, msg_iov(1)=[&#123;<span class="string">"&lt;13&gt;Jul 30 11:01:34 root: newer"</span>, 31&#125;], msg_controllen=28, [&#123;cmsg_len=28, cmsg_level=SOL_SOCKET, cmsg_type=SCM_CREDENTIALS, &#123;pid=35455, uid=0, gid=0&#125;&#125;], msg_flags=0&#125;, MSG_NOSIGNAL) = -1 ESRCH (No such process)</span><br><span class="line">1532962894.732870 sendmsg(5, &#123;msg_name(29)=&#123;sa_family=AF_LOCAL, sun_path=<span class="string">"/run/systemd/journal/syslog"</span>&#125;, msg_iov(1)=[&#123;<span class="string">"&lt;13&gt;Jul 30 11:01:34 root: newer"</span>, 31&#125;], msg_controllen=28, [&#123;cmsg_len=28, cmsg_level=SOL_SOCKET, cmsg_type=SCM_CREDENTIALS, &#123;pid=10247, uid=0, gid=0&#125;&#125;], msg_flags=0&#125;, MSG_NOSIGNAL) = 31</span><br><span class="line">1532962894.733261 open(<span class="string">"/proc/35455/cgroup"</span>, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">1532962894.733307 open(<span class="string">"/proc/35455/comm"</span>, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">1532962894.733331 readlinkat(AT_FDCWD, <span class="string">"/proc/35455/exe"</span>, 0x5590e71435b0, 99) = -1 ENOENT (No such file or directory)</span><br><span class="line">1532962894.733872 open(<span class="string">"/proc/35455/cmdline"</span>, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">1532962894.733923 open(<span class="string">"/proc/35455/status"</span>, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">1532962894.733946 open(<span class="string">"/proc/35455/sessionid"</span>, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">1532962894.733988 open(<span class="string">"/proc/35455/loginuid"</span>, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">1532962894.734014 open(<span class="string">"/proc/35455/cgroup"</span>, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">1532962894.734050 fstat(14, &#123;st_mode=S_IFREG|0640, st_size=8388608, ...&#125;) = 0</span><br><span class="line">1532962894.734146 ftruncate(14, 8388608) = 0</span><br><span class="line"></span><br><span class="line">这里可以看到，35455是logger发送时建立的进程pid</span><br><span class="line">[root@localhost ~]<span class="comment"># journalctl | grep 35455</span></span><br><span class="line">Jul 30 10:31:18 localhost.localdomain root[35455]: 123</span><br><span class="line">Jul 30 10:32:35 localhost.localdomain root[35455]: 123</span><br><span class="line">Jul 30 10:34:03 localhost.localdomain root[35455]: 123</span><br><span class="line">Jul 30 10:35:30 localhost.localdomain root[35455]: 123</span><br><span class="line">Jul 30 11:01:34 localhost.localdomain root[35455]: newer</span><br></pre></td></tr></table></figure>
<h1 id="常见问题">常见问题</h1>
<h2 id="日志重复">日志重复</h2>
<p>见上图，可知默认rsyslog.conf中启动了imuxsock与imjournal两个模块，分别会通过不同的渠道获得syslog日志，因此会导致重复。配置方法详见下章配置信息对应项。</p>
<h2 id="日志丢失">日志丢失</h2>
<h3 id="由于日志频次丢失">由于日志频次丢失</h3>
<p>rsyslog的imjournal模块读取数据库有一个频率上限设置，而systemd-journald也有一个数据库读取频率上限设置。满足rsyslog频率上限，messages中就会drop日志；满足systemd-journald上限，journald就会miss日志。配置方法详见下章配置信息对应项。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsyslogd: imjournal: 84667 messages lost due to rate-limiting</span><br><span class="line"></span><br><span class="line">systemd-journal[1770]: Missed 1427 kernel messages</span><br></pre></td></tr></table></figure>
<h3 id="journal正常rsyslog停止记录日志">journal正常，rsyslog停止记录日志</h3>
<p>当前测试似乎是在/var/log/messages被移动或者被删除或者被轮转了导致的这个问题</p>
<p>在logrotate那里执行了达到100M就轮转的功能，会删除.1文件然后备份</p>
<p>但是这边的现象还是有点怪，在我关闭那个特别高频的日志写入之后，就会更新最新的了，但这是为什么呢？</p>
<p>这里的messages是在/b_iscsi/log/messages里的，这块的设置倒是和我没太大关系，不过原因还是得测试一下，在自己的53.31的/var/log/messages里测试是没什么问题的。</p>
<p>通过lsof，并且从logrotate那里删除自动备份的操作，结果发现，rsyslog还是会出现被删除的情况，但是没找到哪里触发的，</p>
<p>logrotate会在100M时删除 sys_space这个进程会在messages达到110M时删除</p>
<p>Aug 29 17:02:28 localhost syslog: [do_record_log_t:1013] get log info error</p>
<p>目前更换回/var/log/messages，没有出现被删的情况，但是每满130M会出现一次rsyslog不再读取journal的问题,需要移除那个快速写入的程序才能接着更新</p>
<p>看了下卡死的那个时候，rsyslog的lsof显示并不是像我之前想的那样，读取的全都是Deleted文件，反而有些是正常的文件。</p>
<p>刚才试了一下，top里可以看到rsyslog卡死之后读取了30M缓存。</p>
<p>欸，但是命名rsyslog是直接读取systemd-journald数据库啊，哪里有缓存的位置</p>
<h2 id="测试journald数据库性能上限">测试journald数据库性能上限</h2>
<p>数据库文件大小上限设置为2T,在尚未抵达文件大小上限时，出现了间歇的丢失日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Aug  7 15:53:23 localhost journal: Missed 68 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 770 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 16 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 95 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 77 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 65 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 71 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 92 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 110 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 89 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 206 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 5 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 485 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 243 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 105 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 893 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 947 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 837 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 890 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 892 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 914 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 894 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 896 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 888 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 901 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 928 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 887 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 884 kernel messages</span><br><span class="line">Aug  7 15:53:23 localhost journal: Missed 905 kernel messages</span><br><span class="line">:</span><br></pre></td></tr></table></figure>
<h2 id="测试再persistent与volatile状态下数据库停止记录条件">测试再persistent与volatile状态下，数据库停止记录条件</h2>
<p>目前在设置了日志上限的情况下，并没有出现数据库卡死，都是在覆写之前的日志。</p>
<p>在公司镜像上测试，发现，在volatile状态下的日志，和在persistent状态下，同样会自动覆写之前的日志。</p>
<p>仅当journald日志大小达到该分区上限时，目前测试为当RunMaxUse大于分区可用空间时，会导致日志卡死。</p>
<h2 id="imjournald-journal-reloaded问题">imjournald journal reloaded问题</h2>
<p>这个问题在[7]中被提到，主要时由于systemd-journald正在轮转数据库文件，因此导致数据库文件变动，所以会出现这个reload日志。</p>
<p>根据[8]中添加的这个日志信息，可以看到是为了在journald切换文件位置时，为了不用重启rsyslog而添加的自动切换。</p>
<p>经过测试，journal日志每被切割一次，都会产生一个reloaded信息（日志level是info，不是Error，所以可以忽视）</p>
<h2 id="devlog-丢失">/dev/log 丢失</h2>
<p>参照[11]，这个socket似乎在systemd设备上，是由systemd-journald.socket提供， 如果是单独的rsyslog的日志管理下，则是由imuxsock插件创建，</p>
<blockquote>
<p>Normally, with rsyslogd, the imuxsock module will create the /dev/log socket on its own, unlinking the previous entry before creating it. When rsyslogd is stopped (possibly because restart which fails because of faulty configuration), rsyslogd removes /dev/log.</p>
<p>However, the rsyslog supplied with RHEL7 is expected to be used in conjunction with systemd, and the imuxsock module will actually open and remove /run/systemd/journal/syslog socket. Meanwhile, the /dev/log device is created by the system service-file systemd-journald.socket which triggers journald.</p>
</blockquote>
<p>在systemd-journald.socket这个服务的Unit文件里是这么写的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# less /lib/systemd/system/systemd-journald.socket </span><br><span class="line">#  This file is part of systemd.</span><br><span class="line">#</span><br><span class="line">#  systemd is free software; you can redistribute it and/or modify it</span><br><span class="line">#  under the terms of the GNU Lesser General Public License as published by</span><br><span class="line">#  the Free Software Foundation; either version 2.1 of the License, or</span><br><span class="line">#  (at your option) any later version.</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Journal Socket</span><br><span class="line">Documentation=man:systemd-journald.service(8) man:journald.conf(5)</span><br><span class="line">DefaultDependencies=no</span><br><span class="line">Before=sockets.target</span><br><span class="line"></span><br><span class="line"># Mount and swap units need this. If this socket unit is removed by an</span><br><span class="line"># isolate request the mount and swap units would be removed too,</span><br><span class="line"># hence let&apos;s exclude this from isolate requests.</span><br><span class="line">IgnoreOnIsolate=yes</span><br><span class="line"></span><br><span class="line">[Socket]</span><br><span class="line">ListenStream=/run/systemd/journal/stdout</span><br><span class="line">ListenDatagram=/run/systemd/journal/socket</span><br><span class="line">ListenDatagram=/dev/log</span><br><span class="line">SocketMode=0666</span><br><span class="line">PassCredentials=yes</span><br><span class="line">PassSecurity=yes</span><br><span class="line">ReceiveBuffer=8M</span><br></pre></td></tr></table></figure>
<p>这里可以看到监听的/dev/log端口创建是由这个服务管理的。</p>
<h2 id="varlogmessages-时间存在跳变乱序">/var/log/messages 时间存在跳变，乱序</h2>
<p>暂时无法复现</p>
<h2 id="journal-inputoutput-error">journal input/output Error</h2>
<p>理论上来说，应该是journald连接写入到数据库被阻断了，数据库无法访问导致的问题。</p>
<p>不过应该仅针对journalctl读取时的问题</p>
<h2 id="将varlogjournal目录做了软链接后指向路径是被挂载的盘在系统启动尚未挂载上时会导致日志不合并会丢失">将/var/log/journal目录做了软链接后，指向路径是被挂载的盘，在系统启动尚未挂载上时，会导致日志不合并，会丢失</h2>
<p>欸，我试下了，挂载上后，新的日志就看不到了，而卸载掉后，这次启动的日志文件还是在的。</p>
<p>在测试中，新挂载的盘中与systemd-journal并没有建立连接，在lsof中看到的该路径下的文件是现在已经被隐藏了的目录，通过<code>stat</code>查看了文件inode，的确如此。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">systemd-j 432 root   17u      REG                8,1  8388608  531238 /root/log/journal/abf6c3e0a96f452ab2efd6c2d1a9c1e0/system.journal</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@thor ~]# stat /root/log/journal/abf6c3e0a96f452ab2efd6c2d1a9c1e0/system.journal </span><br><span class="line">  File: 鈥root/log/journal/abf6c3e0a96f452ab2efd6c2d1a9c1e0/system.journal鈥</span><br><span class="line">  Size: 8388608    Blocks: 16384      IO Block: 4096   regular file</span><br><span class="line">Device: 811h/2065d      Inode: 42729475    Links: 1</span><br><span class="line">Access: (0640/-rw-r-----)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2018-08-22 14:31:18.865335001 +0800</span><br><span class="line">Modify: 2018-08-22 14:27:43.244195482 +0800</span><br><span class="line">Change: 2018-08-22 14:27:43.244195482 +0800</span><br><span class="line"> Birth: -</span><br><span class="line">[root@thor ~]# umount /dev/sdc1</span><br><span class="line">[root@thor ~]# stat /root/log/journal/abf6c3e0a96f452ab2efd6c2d1a9c1e0/system.journal </span><br><span class="line">  File: 鈥root/log/journal/abf6c3e0a96f452ab2efd6c2d1a9c1e0/system.journal鈥</span><br><span class="line">  Size: 8388608    Blocks: 16408      IO Block: 4096   regular file</span><br><span class="line">Device: 801h/2049d      Inode: 531238      Links: 1</span><br><span class="line">Access: (0640/-rw-r-----)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2018-08-22 14:34:01.246346582 +0800</span><br><span class="line">Modify: 2018-08-22 14:39:01.133367970 +0800</span><br><span class="line">Change: 2018-08-22 14:39:01.133367970 +0800</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure>
<h1 id="配置信息">配置信息</h1>
<h2 id="etcrsyslog.conf">/etc/rsyslog.conf</h2>
<h3 id="modload-imuxsock">$ModLoad imuxsock</h3>
<p>该模块导入监听本机syslog socket的功能，从syslog中接收日志,该配置项依赖systemd-journald.conf中的ForwardToSyslog=Yes</p>
<h4 id="omitlocallogging-与-systemlogsocketname">$OmitLocalLogging 与 $SystemLogSocketName</h4>
<p>该配置信息测试结果与官网有所区别，测试中指定socketName为/dev/log(可修改)，系统默认指向socket为/run/systemd/journal/syslog。使用详见下表。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显式关闭 OmitLocalLog,未指定socketName || 非显式关闭，未指定socketName</span></span><br><span class="line">[root@localhost ~]<span class="comment"># lsof -c rsyslog</span></span><br><span class="line">COMMAND   PID USER   FD   TYPE             DEVICE SIZE/OFF   NODE NAME</span><br><span class="line">rsyslogd 1713 root  cwd    DIR              253,0      224     64 /</span><br><span class="line">rsyslogd 1713 root  rtd    DIR              253,0      224     64 /</span><br><span class="line">rsyslogd 1713 root  txt    REG              253,0   663960    961 /usr/sbin/rsyslogd</span><br><span class="line">rsyslogd 1713 root  mem    REG              253,0    38128   9671 /usr/lib64/rsyslog/imuxsock.so</span><br><span class="line">rsyslogd 1713 root  mem    REG              253,0    24520   9672 /usr/lib64/rsyslog/lmnet.so</span><br><span class="line">rsyslogd 1713 root  mem    REG              253,0  2127336  61000 /usr/lib64/libc-2.17.so</span><br><span class="line">rsyslogd 1713 root  mem    REG              253,0    88720     84 /usr/lib64/libgcc_s-4.8.5-20150702.so.1</span><br><span class="line">rsyslogd 1713 root  mem    REG              253,0    20040  87327 /usr/lib64/libuuid.so.1.3.0</span><br><span class="line">rsyslogd 1713 root  mem    REG              253,0    40824 322855 /usr/lib64/libfastjson.so.4.0.0</span><br><span class="line">rsyslogd 1713 root  mem    REG              253,0    15424 322847 /usr/lib64/libestr.so.0.0.0</span><br><span class="line">rsyslogd 1713 root  mem    REG              253,0    44448  72710 /usr/lib64/librt-2.17.so</span><br><span class="line">rsyslogd 1713 root  mem    REG              253,0    19776  61006 /usr/lib64/libdl-2.17.so</span><br><span class="line">rsyslogd 1713 root  mem    REG              253,0   144792  72706 /usr/lib64/libpthread-2.17.so</span><br><span class="line">rsyslogd 1713 root  mem    REG              253,0    90664  87310 /usr/lib64/libz.so.1.2.7</span><br><span class="line">rsyslogd 1713 root  mem    REG              253,0   164264  60993 /usr/lib64/ld-2.17.so</span><br><span class="line">rsyslogd 1713 root    0r   CHR                1,3      0t0   5423 /dev/null</span><br><span class="line">rsyslogd 1713 root    1w   CHR                1,3      0t0   5423 /dev/null</span><br><span class="line">rsyslogd 1713 root    2w   CHR                1,3      0t0   5423 /dev/null</span><br><span class="line">rsyslogd 1713 root    3u  unix 0xffff880037064800      0t0  29648 /run/systemd/journal/syslog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显式打开OmitLocalLog 并 指定socketName || 并不指定socketName</span></span><br><span class="line">[root@localhost ~]<span class="comment"># lsof -c rsyslog</span></span><br><span class="line">COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF   NODE NAME</span><br><span class="line">rsyslogd 1765 root  cwd    DIR  253,0      224     64 /</span><br><span class="line">rsyslogd 1765 root  rtd    DIR  253,0      224     64 /</span><br><span class="line">rsyslogd 1765 root  txt    REG  253,0   663960    961 /usr/sbin/rsyslogd</span><br><span class="line">rsyslogd 1765 root  mem    REG  253,0    38128   9671 /usr/lib64/rsyslog/imuxsock.so</span><br><span class="line">rsyslogd 1765 root  mem    REG  253,0    24520   9672 /usr/lib64/rsyslog/lmnet.so</span><br><span class="line">rsyslogd 1765 root  mem    REG  253,0  2127336  61000 /usr/lib64/libc-2.17.so</span><br><span class="line">rsyslogd 1765 root  mem    REG  253,0    88720     84 /usr/lib64/libgcc_s-4.8.5-20150702.so.1</span><br><span class="line">rsyslogd 1765 root  mem    REG  253,0    20040  87327 /usr/lib64/libuuid.so.1.3.0</span><br><span class="line">rsyslogd 1765 root  mem    REG  253,0    40824 322855 /usr/lib64/libfastjson.so.4.0.0</span><br><span class="line">rsyslogd 1765 root  mem    REG  253,0    15424 322847 /usr/lib64/libestr.so.0.0.0</span><br><span class="line">rsyslogd 1765 root  mem    REG  253,0    44448  72710 /usr/lib64/librt-2.17.so</span><br><span class="line">rsyslogd 1765 root  mem    REG  253,0    19776  61006 /usr/lib64/libdl-2.17.so</span><br><span class="line">rsyslogd 1765 root  mem    REG  253,0   144792  72706 /usr/lib64/libpthread-2.17.so</span><br><span class="line">rsyslogd 1765 root  mem    REG  253,0    90664  87310 /usr/lib64/libz.so.1.2.7</span><br><span class="line">rsyslogd 1765 root  mem    REG  253,0   164264  60993 /usr/lib64/ld-2.17.so</span><br><span class="line">rsyslogd 1765 root    0r   CHR    1,3      0t0   5423 /dev/null</span><br><span class="line">rsyslogd 1765 root    1w   CHR    1,3      0t0   5423 /dev/null</span><br><span class="line">rsyslogd 1765 root    2w   CHR    1,3      0t0   5423 /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 非显式开启OmitLocalLog ，指定socketName || 显式关闭OmitLocalLog, 并指定SocketName</span></span><br><span class="line">[root@localhost ~]<span class="comment"># lsof -c rsyslog</span></span><br><span class="line">COMMAND   PID USER   FD   TYPE             DEVICE SIZE/OFF     NODE NAME</span><br><span class="line">rsyslogd 1779 root  cwd    DIR              253,0      224       64 /</span><br><span class="line">rsyslogd 1779 root  rtd    DIR              253,0      224       64 /</span><br><span class="line">rsyslogd 1779 root  txt    REG              253,0   663960      961 /usr/sbin/rsyslogd</span><br><span class="line">rsyslogd 1779 root  mem    REG              253,0    38128     9671 /usr/lib64/rsyslog/imuxsock.so</span><br><span class="line">rsyslogd 1779 root  mem    REG              253,0    24520     9672 /usr/lib64/rsyslog/lmnet.so</span><br><span class="line">rsyslogd 1779 root  mem    REG              253,0  2127336    61000 /usr/lib64/libc-2.17.so</span><br><span class="line">rsyslogd 1779 root  mem    REG              253,0    88720       84 /usr/lib64/libgcc_s-4.8.5-20150702.so.1</span><br><span class="line">rsyslogd 1779 root  mem    REG              253,0    20040    87327 /usr/lib64/libuuid.so.1.3.0</span><br><span class="line">rsyslogd 1779 root  mem    REG              253,0    40824   322855 /usr/lib64/libfastjson.so.4.0.0</span><br><span class="line">rsyslogd 1779 root  mem    REG              253,0    15424   322847 /usr/lib64/libestr.so.0.0.0</span><br><span class="line">rsyslogd 1779 root  mem    REG              253,0    44448    72710 /usr/lib64/librt-2.17.so</span><br><span class="line">rsyslogd 1779 root  mem    REG              253,0    19776    61006 /usr/lib64/libdl-2.17.so</span><br><span class="line">rsyslogd 1779 root  mem    REG              253,0   144792    72706 /usr/lib64/libpthread-2.17.so</span><br><span class="line">rsyslogd 1779 root  mem    REG              253,0    90664    87310 /usr/lib64/libz.so.1.2.7</span><br><span class="line">rsyslogd 1779 root  mem    REG              253,0   164264    60993 /usr/lib64/ld-2.17.so</span><br><span class="line">rsyslogd 1779 root    0r   CHR                1,3      0t0     5423 /dev/null</span><br><span class="line">rsyslogd 1779 root    1w   CHR                1,3      0t0     5423 /dev/null</span><br><span class="line">rsyslogd 1779 root    2w   CHR                1,3      0t0     5423 /dev/null</span><br><span class="line">rsyslogd 1779 root    3u  unix 0xffff88003b564800      0t0    30441 /dev/<span class="built_in">log</span></span><br><span class="line">rsyslogd 1779 root    4u  unix 0xffff88003b560800      0t0    30443 socket</span><br><span class="line">rsyslogd 1779 root    5w   REG              253,0   754001 17131680 /var/<span class="built_in">log</span>/messages</span><br><span class="line">rsyslogd 1779 root    6w   REG              253,0    24654 17131681 /var/<span class="built_in">log</span>/secure</span><br></pre></td></tr></table></figure>
<p>由上述可知，在不同情况下，rsyslog实际监听的socket如下</p>
<table>
<thead>
<tr class="header">
<th>x</th>
<th>显式开启</th>
<th>显式关闭</th>
<th>非显式开启</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>指定socket</td>
<td>null</td>
<td>/dev/log</td>
<td>/dev/log</td>
</tr>
<tr class="even">
<td>不指定socket</td>
<td>null</td>
<td>/run/systemd/journal/syslog</td>
<td>/run/systemd/journal/syslog</td>
</tr>
</tbody>
</table>
<h3 id="modload-imjournal">$ModLoad imjournal</h3>
<p>该模块导入直接读取systemd-journald数据库的功能，可直接从journald数据库中读取syslog日志、内核日志以及服务stdout。</p>
<p>imjournal在lsof中可以看到，直接读取的数据库 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># lsof  /run/log/journal/a288ec3729494d3dad642453d0b272b7/system.journal</span></span><br><span class="line">COMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF    NODE NAME</span><br><span class="line">systemd-j 10247 root  mem    REG   0,19 25165824 7373149 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system.journal</span><br><span class="line">systemd-j 10247 root   12u   REG   0,19 25165824 7373149 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system.journal</span><br><span class="line">rsyslogd  10255 root  mem    REG   0,19 25165824 7373149 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system.journal</span><br><span class="line">rsyslogd  10255 root    5r   REG   0,19 25165824 7373149 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system.journal</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># lsof -c systemd-journal</span></span><br><span class="line">COMMAND     PID USER   FD      TYPE             DEVICE SIZE/OFF     NODE NAME</span><br><span class="line">systemd-j 10247 root  cwd       DIR              253,0      224       64 /</span><br><span class="line">systemd-j 10247 root  rtd       DIR              253,0      224       64 /</span><br><span class="line">systemd-j 10247 root  txt       REG              253,0   274752 16874824 /usr/lib/systemd/systemd-journald</span><br><span class="line">systemd-j 10247 root  mem       REG               0,19 25165824  7373149 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system.journal</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0    19888    87389 /usr/lib64/libattr.so.1.1.0</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0   402384    87259 /usr/lib64/libpcre.so.1.2.0</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0    19776    61006 /usr/lib64/libdl-2.17.so</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0    19384    87371 /usr/lib64/libgpg-error.so.0.10.0</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0  2127336    61000 /usr/lib64/libc-2.17.so</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0   144792    72706 /usr/lib64/libpthread-2.17.so</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0    88720       84 /usr/lib64/libgcc_s-4.8.5-20150702.so.1</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0    44448    72710 /usr/lib64/librt-2.17.so</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0    37056    87391 /usr/lib64/libacl.so.1.1.0</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0   155744    87307 /usr/lib64/libselinux.so.1</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0   535064    87381 /usr/lib64/libgcrypt.so.11.8.2</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0   157424    87316 /usr/lib64/liblzma.so.5.2.2</span><br><span class="line">systemd-j 10247 root  mem       REG              253,0   164264    60993 /usr/lib64/ld-2.17.so</span><br><span class="line">systemd-j 10247 root  mem       REG               0,19        8     7972 /run/systemd/journal/kernel-seqnum</span><br><span class="line">systemd-j 10247 root    0r      CHR                1,3      0t0     5423 /dev/null</span><br><span class="line">systemd-j 10247 root    1w      CHR                1,3      0t0     5423 /dev/null</span><br><span class="line">systemd-j 10247 root    2w      CHR                1,3      0t0     5423 /dev/null</span><br><span class="line">systemd-j 10247 root    3u     unix 0xffff880037e83000      0t0    42542 /run/systemd/journal/stdout</span><br><span class="line">systemd-j 10247 root    4u     unix 0xffff880037e81400      0t0    42544 /run/systemd/journal/socket</span><br><span class="line">systemd-j 10247 root    5u     unix 0xffff880037e80800      0t0    42546 /dev/<span class="built_in">log</span></span><br><span class="line">systemd-j 10247 root    6w      CHR               1,11      0t0     5429 /dev/kmsg</span><br><span class="line">systemd-j 10247 root    7u  a_inode                0,9        0     5419 [eventpoll]</span><br><span class="line">systemd-j 10247 root    8u  a_inode                0,9        0     5419 [timerfd]</span><br><span class="line">systemd-j 10247 root    9u      CHR               1,11      0t0     5429 /dev/kmsg</span><br><span class="line">systemd-j 10247 root   10r      REG                0,3        0     7973 /proc/sys/kernel/hostname</span><br><span class="line">systemd-j 10247 root   11u  a_inode                0,9        0     5419 [signalfd]</span><br><span class="line">systemd-j 10247 root   12u      REG               0,19 25165824  7373149 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system.journal</span><br><span class="line">systemd-j 10247 root   13u  a_inode                0,9        0     5419 [timerfd]</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># lsof -c rsyslog</span></span><br><span class="line">COMMAND    PID USER   FD      TYPE             DEVICE SIZE/OFF     NODE NAME</span><br><span class="line">rsyslogd 10255 root  cwd       DIR              253,0      224       64 /</span><br><span class="line">rsyslogd 10255 root  rtd       DIR              253,0      224       64 /</span><br><span class="line">rsyslogd 10255 root  txt       REG              253,0   663960      961 /usr/sbin/rsyslogd</span><br><span class="line">rsyslogd 10255 root  mem       REG               0,19 25165824   307917 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system@cea802f344b94cb6b1e2b867690eca83-0000000000000f6d-0005722d8a52e79b.journal</span><br><span class="line">rsyslogd 10255 root  mem       REG               0,19 25165824  2282729 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system@cea802f344b94cb6b1e2b867690eca83-00000000000074f5-0005722d9bdab060.journal</span><br><span class="line">rsyslogd 10255 root  mem       REG               0,19 25165824  4612418 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system@cea802f344b94cb6b1e2b867690eca83-000000000000dcd4-0005722db4fed7dd.journal</span><br><span class="line">rsyslogd 10255 root  mem       REG               0,19 25165824  7373149 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system.journal</span><br><span class="line">rsyslogd 10255 root  mem       REG               0,19  6455296     7976 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system@cea802f344b94cb6b1e2b867690eca83-0000000000000001-000571ff63cd3044.journal</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    68192    87353 /usr/lib64/libbz2.so.1.0.6</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    99944    87368 /usr/lib64/libelf-0.168.so</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0   402384    87259 /usr/lib64/libpcre.so.1.2.0</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    19888    87389 /usr/lib64/libattr.so.1.1.0</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0   297328   115274 /usr/lib64/libdw-0.168.so</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0   111080    72708 /usr/lib64/libresolv-2.17.so</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    19384    87371 /usr/lib64/libgpg-error.so.0.10.0</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0   535064    87381 /usr/lib64/libgcrypt.so.11.8.2</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0   157424    87316 /usr/lib64/liblzma.so.5.2.2</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0   155744    87307 /usr/lib64/libselinux.so.1</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0  1139680    61008 /usr/lib64/libm-2.17.so</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    20032    87393 /usr/lib64/libcap.so.2.22</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    25072     9665 /usr/lib64/rsyslog/imjournal.so</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    24520     9672 /usr/lib64/rsyslog/lmnet.so</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0  2127336    61000 /usr/lib64/libc-2.17.so</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    88720       84 /usr/lib64/libgcc_s-4.8.5-20150702.so.1</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    20040    87327 /usr/lib64/libuuid.so.1.3.0</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    40824   322855 /usr/lib64/libfastjson.so.4.0.0</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    15424   322847 /usr/lib64/libestr.so.0.0.0</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    44448    72710 /usr/lib64/librt-2.17.so</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    19776    61006 /usr/lib64/libdl-2.17.so</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0   144792    72706 /usr/lib64/libpthread-2.17.so</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0    90664    87310 /usr/lib64/libz.so.1.2.7</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0   164264    60993 /usr/lib64/ld-2.17.so</span><br><span class="line">rsyslogd 10255 root  mem       REG              253,0   162560   237027 /usr/lib64/libsystemd.so.0.6.0</span><br><span class="line">rsyslogd 10255 root    0r      CHR                1,3      0t0     5423 /dev/null</span><br><span class="line">rsyslogd 10255 root    1w      CHR                1,3      0t0     5423 /dev/null</span><br><span class="line">rsyslogd 10255 root    2w      CHR                1,3      0t0     5423 /dev/null</span><br><span class="line">rsyslogd 10255 root    3r  a_inode                0,9        0     5419 inotify</span><br><span class="line">rsyslogd 10255 root    4u     unix 0xffff880037338800      0t0  9404081 socket</span><br><span class="line">rsyslogd 10255 root    5r      REG               0,19 25165824  7373149 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system.journal</span><br><span class="line">rsyslogd 10255 root    6r      REG               0,19 25165824  4612418 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system@cea802f344b94cb6b1e2b867690eca83-000000000000dcd4-0005722db4fed7dd.journal</span><br><span class="line">rsyslogd 10255 root    7r      REG               0,19 25165824  2282729 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system@cea802f344b94cb6b1e2b867690eca83-00000000000074f5-0005722d9bdab060.journal</span><br><span class="line">rsyslogd 10255 root    8r      REG               0,19 25165824   307917 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system@cea802f344b94cb6b1e2b867690eca83-0000000000000f6d-0005722d8a52e79b.journal</span><br><span class="line">rsyslogd 10255 root    9r      REG               0,19  6455296     7976 /run/<span class="built_in">log</span>/journal/a288ec3729494d3dad642453d0b272b7/system@cea802f344b94cb6b1e2b867690eca83-0000000000000001-000571ff63cd3044.journal</span><br><span class="line">rsyslogd 10255 root   10w      REG              253,0 49250519 17152683 /var/<span class="built_in">log</span>/messages</span><br><span class="line">rsyslogd 10255 root   11w      REG              253,0     4634 17152684 /var/<span class="built_in">log</span>/secure</span><br></pre></td></tr></table></figure></p>
<h4 id="imjournalratelimitinterval-0">$imjournalRatelimitInterval 0</h4>
<p>该属性设置为5s,代表以5s为一个间隙统计日志频次，达到下一条配置设置的频次，即放弃读取journald数据库信息(待验证是读取前放弃，还是读取后丢弃)。</p>
<h4 id="imjournalratelimitburst-0">$imjournalRatelimitBurst 0</h4>
<p>该属性设置为上一条设置的间隙期间读取日志条数上限，如5s内读取1000条，达到该频次即停止。与上一条同时设置为0，即关闭该上限</p>
<blockquote>
<p>Note that it is not recommended to turn of ratelimiting, except that you know for sure journal database entries will never be corrupted. Without ratelimiting, a corrupted systemd journal database may cause a kind of denial of service (we are stressing this point as multiple users have reported us such problems with the journal database - information current as of June 2013).</p>
</blockquote>
<p>但是官方并不建议关闭该上限，可能会导致数据库阻塞等问题导致其他服务出现异常。</p>
<h3 id="modload-imklog">$ModLoad imklog</h3>
<p>该模块导入直接从平台内核中读取内核日志的功能，可以避过journald数据库读写性能瓶颈。</p>
<h3 id="modload-imkmsg">$ModLoad imkmsg</h3>
<p>该模块通过/dev/kmsg设备，获取结构化日志</p>
<h3 id="modload-imudp">$ModLoad imudp</h3>
<p>导入该模块，并打开防火墙放行，可远程访问该主机获取日志信息</p>
<h3 id="modload-imtcp">$ModLoad imtcp</h3>
<p>导入该模块，并打开防火墙放行，可远程访问该主机获取日志信息</p>
<h3 id="转发规则">转发规则</h3>
<p>rhel7系统中，一般log默认保存在下述目录，/var/log 目录保管由rsyslog维护的各种特定于系统和服务的日志文件。</p>
<p>/var/log/messages大多数系统日志消息记录在此。例外是与身份验证，电子邮件处理相关的定期运行作业的消息以及纯粹与调试相关的信息。 /var/log/secure安全和身份验证相关的消息和错误的日志文件。 /var/log/maillog与邮件服务器相关的日志文件。 /var/log/cron crond计划任务的日志 /var/log/boot.log与系统启动相关的消息记录在此。</p>
<p>建议不直接修改rsyslog.conf的规则，在这个目录<code>$IncludeConfig /etc/rsyslog.d/*.conf</code>下存放自定义的转发规则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">:msg, contains, <span class="string">"of user root"</span>            ~ </span><br><span class="line">&amp; ~</span><br><span class="line"></span><br><span class="line">:msg, contains, <span class="string">"Removed session"</span>            ~ </span><br><span class="line">&amp; ~</span><br><span class="line"></span><br><span class="line">:msg, contains, <span class="string">"please try to use systemctl"</span>		~</span><br><span class="line">&amp; ~	</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log all kernel messages to the console.</span></span><br><span class="line"><span class="comment"># Logging much else clutters up the screen.</span></span><br><span class="line"><span class="comment">#kern.*                                                 /dev/console</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Log anything (except mail) of level info or higher.</span></span><br><span class="line"><span class="comment"># Don't log private authentication messages!</span></span><br><span class="line">*.info;mail.none;authpriv.none;cron.none                /var/<span class="built_in">log</span>/messages</span><br><span class="line"></span><br><span class="line"><span class="comment"># The authpriv file has restricted access.</span></span><br><span class="line">authpriv.*                                              /var/<span class="built_in">log</span>/secure</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log all the mail messages in one place.</span></span><br><span class="line">mail.*                                                  -/var/<span class="built_in">log</span>/maillog</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Log cron stuff</span></span><br><span class="line">cron.*                                                  /var/<span class="built_in">log</span>/cron</span><br><span class="line"></span><br><span class="line"><span class="comment"># Everybody gets emergency messages</span></span><br><span class="line">*.emerg                                                 :omusrmsg:*</span><br><span class="line"></span><br><span class="line"><span class="comment"># Save news errors of level crit and higher in a special file.</span></span><br><span class="line">uucp,news.crit                                          /var/<span class="built_in">log</span>/spooler</span><br><span class="line"></span><br><span class="line"><span class="comment"># Save boot messages also to boot.log</span></span><br><span class="line">local7.*                                                /var/<span class="built_in">log</span>/boot.log</span><br></pre></td></tr></table></figure>
<p>转发过滤规则，见<a href="https://www.rsyslog.com/doc/v8-stable/configuration/filters.html?highlight=info%20mail%20none%20authpriv%20none%20cron%20none%20news%20none" target="_blank" rel="noopener">文档</a></p>
<h3 id="begin-forwarding-rule">begin forwarding rule</h3>
<p>暂未使用的远程访问日志配置信息，语法见<a href="https://www.rsyslog.com/doc/v8-stable/configuration/action/index.html?highlight=actionfiledefaulttemplate" target="_blank" rel="noopener">Legacy Action-Specific Configuration Statements</a></p>
<h2 id="etcsystemdjournald.conf">/etc/systemd/journald.conf</h2>
<p>systemd-journald主要获得以下信息 * Kernel log messages, via kmsg * Simple system log messages, via the libc syslog(3) call * Structured system log messages via the native Journal API, see sd_journal_print(4) * Standard output and standard error of service units. For further details see below. * Audit records, originating from the kernel audit subsystem</p>
<h3 id="ratelimitinterval30s">RateLimitInterval=30s</h3>
<p>频率间隙为30s</p>
<h3 id="ratelimitburst1000">RateLimitBurst=1000</h3>
<p>每个间隙频次上限为1000，直到下个间隙不会接收日志</p>
<h3 id="storageauto">Storage=auto</h3>
<p>该配置选项控制journald日志的存储位置，以下4个选项“volatile”, “persistent”, “auto” and “none”，对应<code>/run/log/journal</code>,<code>/var/log/journal</code>,根据<code>/var/log/journal</code>目录建立与否判断，收到即drop,但转发forward还是生效的(如imjournal等读取数据库文件等方式无效)。</p>
<h3 id="runtimemaxuse">RuntimeMaxUse=</h3>
<p>设置内存中journald文件上限，一旦达到该上限，journald数据库就会阻塞住。</p>
<h3 id="runtimekeepfree">RuntimeKeepFree=</h3>
<p>RuntimeKeepFree表示需要保留的内存空间，剩余空间不足其设置，journald数据库同样会阻塞住。</p>
<p>SystemMaxUse= 与 RuntimeMaxUse= 的默认值是10%空间与4G空间两者中的较小者； SystemKeepFree= 与 RuntimeKeepFree= 的默认值是15%空间与4G空间两者中的较大者； 如果在 systemd-journald 启动时， 文件系统即将被填满并且已经超越了 SystemKeepFree= 或 RuntimeKeepFree= 的限制，那么日志记录将被暂停。 也就是说，如果在创建日志文件时，文件系统有充足的空闲空间， 但是后来文件系统被其他非日志文件过多占用， 那么 systemd-journald 只会立即暂停日志记录， 但不会删除已经存在的日志文件。</p>
<h3 id="runtimemaxfilesize">RuntimeMaxFileSize=</h3>
<p>SystemMaxFileSize= 与 RuntimeMaxFileSize= 限制单个日志文件的最大体积， 到达此限制后日志文件将会自动滚动。 默认值是对应的 SystemMaxUse= 与 RuntimeMaxUse= 值的1/8 ， 这也意味着日志滚动默认保留7个历史文件。</p>
<p>日志大小的值可以使用以1024为基数的 K, M, G, T, P, E 后缀， 分别对应于 1024, 1024², … 字节。</p>
<h3 id="forwardtosyslogyes">ForwardToSyslog=yes</h3>
<p>转发syslog日志到syslog socket，从而使rsyslog调用imuxsock从该socket接收日志</p>
<p>该选项可被内核引导选项覆盖<code>systemd.journald.forward_to_syslog=, systemd.journald.forward_to_kmsg=, systemd.journald.forward_to_console=, systemd.journald.forward_to_wall=</code>，允许/禁止将收集到的日志： 转发到传统的 syslog 守护进程, 转发到内核日志缓冲区, 转发到系统控制台, 作为wall警告信息转发给所有已登录的用户</p>
<h3 id="maxlevelstoredebug">MaxLevelStore=debug</h3>
<ul>
<li>MaxLevelSyslog=debug</li>
<li>MaxLevelKMsg=notice</li>
<li>MaxLevelConsole=info</li>
<li>MaxLevelWall=emerg</li>
</ul>
<p>以上配置控制在数据库上存储以及转发的最大日志等级。</p>
<p>日志等级一共分为“emerg”, “alert”, “crit”, “err”, “warning”, “notice”,“info”, “debug”</p>
<h2 id="libsystemdsystemsystemd-journald.service">/lib/systemd/system/systemd-journald.service</h2>
<h3 id="standardoutputnull">StandardOutput=null</h3>
<p>设置进程的标准输出(STDOUT)。 可设为 inherit, null, tty, journal, syslog, kmsg, journal+console, syslog+console, kmsg+console, socket, fd 之一。</p>
<ul>
<li>inherit 表示使用 StandardInput= 设置的值。</li>
<li>null 表示 /dev/null ， 也就是所有写入都会被丢弃。</li>
<li>tty 表示 TTY(由 TTYPath= 设置)， 如果仅用于输出， 那么进程将无需取得终端的控制权， 亦无需等待其他进程释放终端控制权。</li>
<li>journal 表示 systemd 日志服务(通过 journalctl(1) 访问)。 注意，所有发到 syslog 或 kmsg 的日志都会 隐含的复制一份到 journal 中。</li>
<li>syslog 表示 syslog(3) 日志服务。 注意，此时所有日志都会隐含的复制一份到 journal 中。</li>
<li>kmsg 表示内核日志缓冲区(通过 dmesg(1) 访问)。 注意，此时所有日志都会隐含的复制一份到 journal 中。</li>
<li>journal+console, syslog+console, kmsg+console 与上面三个值类似， 不同之处在于所有日志都会再复制一份到系统的控制台上。</li>
<li>socket 的解释与 StandardInput= 中的解释完全相同。</li>
<li>fd 表示将标准输出(STDOUT)连接到一个由 socket 单元提供的文件描述符。 可以通过 “fd:foobar” 格式 明确指定文件描述符的名称。 描述符名称的默认值为 “stdout” ，也就是 “fd” 等价于 “fd:stdout” 。 必须明确使用 Sockets= 选项 提供至少一个定义了文件描述符名称的 socket 单元。 注意，文件描述符的名称不一定和定义它的 socket 单元的名称一致。 如果出现了多个匹配，那么以第一个为准， 详见 systemd.socket(5) 手册对 FileDescriptorName= 选项的讲解。</li>
</ul>
<p>如果单元的标准输出(StandardOutput=)或标准错误(StandardError=)中含有 journal, syslog, kmsg 之一， 那么该单元将会自动隐含的获得 After=systemd-journald.socket 依赖(见上文)。</p>
<h2 id="etclogrotate.conf">/etc/logrotate.conf</h2>
<p>仅对持久化后的/var/log/journal有效</p>
<h2 id="journald持久化">journald持久化</h2>
<p>持久化保存journal的日志，默认保存一个月的日志</p>
<p>直接修改journald.conf中的storage为persistent就切换到var路径下了，切换到volatile就自动回/run/log了。 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart systemd-journald.service</span><br><span class="line">systemctl restart systemd-journald.socket</span><br></pre></td></tr></table></figure></p>
<p>如果出现了切换到persistent状态下，日志已经存到了/var/log/journal，但是/run/log/journal路径依旧存在的状况的话，可能是自动切换有些不同。就手动将volatile修改成auto,手动<code>mkdir /var/log/journal</code>，这样再重启比较适合防丢日志。</p>
<p>在切换前，为了防止journal数据库文件大小刚好超过设置的上限，然后由于重启了服务，没能及时自动清理掉超过的部分，从而导致数据库假死，建议使用<code>journalctl --vacuumm-size=250M</code>，可以清除日志直到满足这个大小限制。不过这个要求sytemd版本318及以上才支持这个选项。</p>
<p>如果版本不支持的话，那就还是<code>rm -rf</code>掉这些日志或者手动删掉一些数据库文件吧，升级systemd的版本似乎带来的风险相比这些日志的价值要大得多。[12]</p>
<h1 id="调试方法">调试方法</h1>
<h2 id="检验rsyslog配置信息">检验rsyslog配置信息</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以让rsyslogd 进入 Debug模式</span></span><br><span class="line">[root@localhost ~]<span class="comment"># rsyslogd -N6</span></span><br><span class="line">rsyslogd: version 8.24.0, config validation run (level 6), master config /etc/rsyslog.conf</span><br><span class="line">rsyslogd: invalid or yet-unknown config file <span class="built_in">command</span> <span class="string">'IMJournalStateFile'</span> - have you forgotten to load a module? [v8.24.0 try http://www.rsyslog.com/e/3003 ]</span><br></pre></td></tr></table></figure>
<h2 id="strace--p-pid追踪进程">strace -p pid追踪进程</h2>
<h1 id="参考资料">参考资料</h1>
<ol type="1">
<li><a href="https://www.rsyslog.com/doc/v8-stable/configuration/modules/imjournal.html?highlight=imjournalstatefile" target="_blank" rel="noopener">imjournal: Systemd Journal Input Module</a></li>
<li><a href="https://unix.stackexchange.com/questions/196877/rsyslog-logger-message-duplicated" target="_blank" rel="noopener">rsyslog-logger-message-duplicated</a></li>
<li><a href="https://zh.opensuse.org/openSUSE:How_to_write_a_systemd_service" target="_blank" rel="noopener">systemd service 单元语法</a></li>
<li><a href="https://www.rsyslog.com/doc/v8-stable/configuration/filters.html?highlight=info%20mail%20none%20authpriv%20none%20cron%20none%20news%20none" target="_blank" rel="noopener">Filter Conditions</a></li>
<li><a href="https://www.rsyslog.com/doc/v8-stable/configuration/modules/imuxsock.html?highlight=omitlocallogging" target="_blank" rel="noopener">imuxsock: Unix Socket Input Module</a></li>
<li><a href="http://www.jinbuguo.com/systemd/journald.conf.html" target="_blank" rel="noopener">man journald.conf</a></li>
<li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1497985" target="_blank" rel="noopener">rsyslog daemon have unkown log entries “rsyslogd:imjournal: journal reloaded” from time to time</a></li>
<li><a href="https://github.com/rsyslog/rsyslog/pull/1747/files#diff-b1ea6478b8060f07cd30ecde78bfdc49R518" target="_blank" rel="noopener">switching to persistent journal possible without rsyslog restart</a></li>
<li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1495631" target="_blank" rel="noopener">Journal is reloaded and duplicate messages are output into log file</a></li>
<li><a href="http://www.tsingfun.com/html/2015/dev_1123/high_performance_rsyslogd.html" target="_blank" rel="noopener">关于Rsyslogd 的一些配置 (高性能、高可用 rsyslogd)</a></li>
<li><a href="https://unix.stackexchange.com/questions/317064/how-do-i-restore-dev-log-in-systemdrsyslog-host" target="_blank" rel="noopener">How do I restore <code>/dev/log</code> in systemd+rsyslog host?</a></li>
<li><a href="https://askubuntu.com/questions/627174/how-would-i-upgrade-systemd" target="_blank" rel="noopener">How would I upgrade systemd?</a></li>
<li><a href="https://unix.stackexchange.com/questions/332274/is-systemd-journald-a-syslog-implementation" target="_blank" rel="noopener">Is systemd-journald a syslog implementation?</a></li>
</ol>

      
    </div>

    

    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Sean10</li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://sean10.github.io/2018/08/02/undefined/" title="rsyslog & journald日志系统结构">https://sean10.github.io/2018/08/02/undefined/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/linux/" rel="tag"># linux</a>
          
            <a href="/tags/rsyslog/" rel="tag"># rsyslog</a>
          
            <a href="/tags/systemd/" rel="tag"># systemd</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/28/undefined/" rel="next" title="RMBP_me865换屏小记">
                <i class="fa fa-chevron-left"></i> RMBP_me865换屏小记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/09/tech/" rel="prev" title="frp远程桌面尝试">
                frp远程桌面尝试 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Sean10</p>
              <p class="site-description motion-element" itemprop="description">笔记 随笔</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">135</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">128</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基本背景"><span class="nav-number">1.</span> <span class="nav-text">基本背景</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实验环境"><span class="nav-number">1.1.</span> <span class="nav-text">实验环境</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rsyslog与systemd-journald日志流向"><span class="nav-number">2.</span> <span class="nav-text">rsyslog与systemd-journald日志流向</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#常见问题"><span class="nav-number">3.</span> <span class="nav-text">常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#日志重复"><span class="nav-number">3.1.</span> <span class="nav-text">日志重复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志丢失"><span class="nav-number">3.2.</span> <span class="nav-text">日志丢失</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#由于日志频次丢失"><span class="nav-number">3.2.1.</span> <span class="nav-text">由于日志频次丢失</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#journal正常rsyslog停止记录日志"><span class="nav-number">3.2.2.</span> <span class="nav-text">journal正常，rsyslog停止记录日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试journald数据库性能上限"><span class="nav-number">3.3.</span> <span class="nav-text">测试journald数据库性能上限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试再persistent与volatile状态下数据库停止记录条件"><span class="nav-number">3.4.</span> <span class="nav-text">测试再persistent与volatile状态下，数据库停止记录条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#imjournald-journal-reloaded问题"><span class="nav-number">3.5.</span> <span class="nav-text">imjournald journal reloaded问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#devlog-丢失"><span class="nav-number">3.6.</span> <span class="nav-text">/dev/log 丢失</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#varlogmessages-时间存在跳变乱序"><span class="nav-number">3.7.</span> <span class="nav-text">/var/log/messages 时间存在跳变，乱序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#journal-inputoutput-error"><span class="nav-number">3.8.</span> <span class="nav-text">journal input/output Error</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#将varlogjournal目录做了软链接后指向路径是被挂载的盘在系统启动尚未挂载上时会导致日志不合并会丢失"><span class="nav-number">3.9.</span> <span class="nav-text">将/var/log/journal目录做了软链接后，指向路径是被挂载的盘，在系统启动尚未挂载上时，会导致日志不合并，会丢失</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置信息"><span class="nav-number">4.</span> <span class="nav-text">配置信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#etcrsyslog.conf"><span class="nav-number">4.1.</span> <span class="nav-text">/etc/rsyslog.conf</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#modload-imuxsock"><span class="nav-number">4.1.1.</span> <span class="nav-text">$ModLoad imuxsock</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#omitlocallogging-与-systemlogsocketname"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">$OmitLocalLogging 与 $SystemLogSocketName</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#modload-imjournal"><span class="nav-number">4.1.2.</span> <span class="nav-text">$ModLoad imjournal</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#imjournalratelimitinterval-0"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">$imjournalRatelimitInterval 0</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#imjournalratelimitburst-0"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">$imjournalRatelimitBurst 0</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#modload-imklog"><span class="nav-number">4.1.3.</span> <span class="nav-text">$ModLoad imklog</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#modload-imkmsg"><span class="nav-number">4.1.4.</span> <span class="nav-text">$ModLoad imkmsg</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#modload-imudp"><span class="nav-number">4.1.5.</span> <span class="nav-text">$ModLoad imudp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#modload-imtcp"><span class="nav-number">4.1.6.</span> <span class="nav-text">$ModLoad imtcp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#转发规则"><span class="nav-number">4.1.7.</span> <span class="nav-text">转发规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#begin-forwarding-rule"><span class="nav-number">4.1.8.</span> <span class="nav-text">begin forwarding rule</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcsystemdjournald.conf"><span class="nav-number">4.2.</span> <span class="nav-text">/etc/systemd/journald.conf</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ratelimitinterval30s"><span class="nav-number">4.2.1.</span> <span class="nav-text">RateLimitInterval=30s</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ratelimitburst1000"><span class="nav-number">4.2.2.</span> <span class="nav-text">RateLimitBurst=1000</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#storageauto"><span class="nav-number">4.2.3.</span> <span class="nav-text">Storage=auto</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#runtimemaxuse"><span class="nav-number">4.2.4.</span> <span class="nav-text">RuntimeMaxUse=</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#runtimekeepfree"><span class="nav-number">4.2.5.</span> <span class="nav-text">RuntimeKeepFree=</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#runtimemaxfilesize"><span class="nav-number">4.2.6.</span> <span class="nav-text">RuntimeMaxFileSize=</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#forwardtosyslogyes"><span class="nav-number">4.2.7.</span> <span class="nav-text">ForwardToSyslog=yes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#maxlevelstoredebug"><span class="nav-number">4.2.8.</span> <span class="nav-text">MaxLevelStore=debug</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#libsystemdsystemsystemd-journald.service"><span class="nav-number">4.3.</span> <span class="nav-text">/lib/systemd/system/systemd-journald.service</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#standardoutputnull"><span class="nav-number">4.3.1.</span> <span class="nav-text">StandardOutput=null</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etclogrotate.conf"><span class="nav-number">4.4.</span> <span class="nav-text">/etc/logrotate.conf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#journald持久化"><span class="nav-number">4.5.</span> <span class="nav-text">journald持久化</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#调试方法"><span class="nav-number">5.</span> <span class="nav-text">调试方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#检验rsyslog配置信息"><span class="nav-number">5.1.</span> <span class="nav-text">检验rsyslog配置信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#strace--p-pid追踪进程"><span class="nav-number">5.2.</span> <span class="nav-text">strace -p pid追踪进程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">6.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sean10</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="Symbols count total">360k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="Reading time total">5:27</span>
  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
      <div>
        <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox">
  <script type = "text/javascript" src = "//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57108c0b91bea817" async = "async" ></script>
</div>

      </div>
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: 'yNexbxJmshSneppnaoo3Bd6Y-gzGzoHsz',
        appKey: 'FyxT8MxDPHbu8mQSapgjEMPC',
        placeholder: 'Just go go',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: true
    });
  </script>



  





  

  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      TeX: {equationNumbers: { autoNumber: "AMS" }}
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

    
  


  
  

  

  

  

  

  

</body>
</html>
