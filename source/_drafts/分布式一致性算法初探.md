---
title: [施工中]分布式一致性算法初探
subtitle: tech
date: 2023-05-16 20:29:07
updated:
tags: [分布式]
categories: [专业]
---



主要存在以下几类paxos需要应对的场景

主要是prepare的承诺阶段

> 决策节点收到后，会给提案节点两个承诺一个应答：
> 
> 两个承诺：
> 
> 承诺不会再接受提案 ID 小于或等于 n 的 Prepare 请求；
> 承诺不会再接受提案 ID 小于 n 的 Accept 请求。
> 一个应答：
> 
> 在不违背以前作出的承诺的前提下，回复已经批准过的提案中 ID 最大的那个提案所设定的值和提案 ID，如果该值从来没有被任何提案设定过，则返回空值。如果违反此前做出的承诺，也就是说收到的提案 ID 并不是决策节点收到过的最大的，那就可以直接不理会这个 Prepare 请求。

### 完全顺利的一次选举
TODO: 时序图是不是不适合表达场景? 不然要画好多张? 是不是应该把响应直接具象化呢?
#### 成功prepare, 但被acceptor拒绝

``` mermaid
%%{init: {'theme':'forest'}}%%
  sequenceDiagram 
  autonumber
    Proposer1-)Acceptor1: propose(1)
    Proposer1-)Acceptor2: propose(1)
	Proposer1-)Acceptor3: propose(1)
	Acceptor1--)Proposer1: promise(1)
	Acceptor2--)Proposer1: promise(1)
	Acceptor3--)Proposer1: promise(1)
	Proposer2-)Acceptor1: propose(2)
	Proposer2-)Acceptor2: propose(2)
	Proposer2-)Acceptor3: propose(2)
	Acceptor1--)Proposer2: promise(2)
	Acceptor2--)Proposer2: promise(2)
	Acceptor3--)Proposer2: promise(2)
	Proposer1-)Acceptor1: accept(1, value1)
    Proposer1-)Acceptor2: accept(1, value1)
	Proposer1-)Acceptor3: accept(1, value1)
	Acceptor1--xProposer1: rejected(1)
	Acceptor2--xProposer1: rejected(1)
	Acceptor3--xProposer1: rejected(1)
	
```

#### 成功通过prepare, accept也成功


``` mermaid
%%{init: {'theme':'forest'}}%%
  sequenceDiagram 
  autonumber
    Proposer1-)Acceptor1: propose(1)
    Proposer1-)Acceptor2: propose(1)
	Proposer1-)Acceptor3: propose(1)
	Acceptor1--)Proposer1: promise(1)
	Acceptor2--)Proposer1: promise(1)
	Acceptor3--)Proposer1: promise(1)
	Proposer2-)Acceptor1: propose(2)
	Proposer2-)Acceptor2: propose(2)
	Proposer2-)Acceptor3: propose(2)
	Acceptor1--)Proposer2: promise(2)
	Acceptor2--)Proposer2: promise(2)
	Acceptor3--)Proposer2: promise(2)
	Proposer1-)Acceptor1: accept(1, value1)
    Proposer1-)Acceptor2: accept(1, value1)
	Proposer1-)Acceptor3: accept(1, value1)
	Acceptor1--xProposer1: rejected(1)
	Acceptor2--xProposer1: rejected(1)
	Acceptor3--xProposer1: rejected(1)
	
```


## 疑问
### 这里的提案编号有一个疑问, 是瞬时的还是有一个累计的时间窗口的概念的?
瞬时的, 因为这里接收的提案具体指的主要是准备阶段.

### Preproser如何感知到自己的提案被打断?
在发送提案时, 收到的请求是被打断的?


### 提案被拒绝是否要返回消息呢?

## Multi Paxos
* 增加领导选举


## Fast Paxos


# paxos开源实现解读

## [zzy590/zpaxos: C\+\+ header only multi\-paxos library\.](https://github.com/zzy590/zpaxos)

