---
title: ceph之快照的应用一致性初探
subtitle: tech
date: 2023-06-11 23:52:15
updated:
tags: [ceph, consistency, snapshot]
categories: [专业]
---




当我们提供的是文件系统的时候, 则确实通过上面提到的文件系统的解决方案就可以规避. 这部分提供澄清的接口遭遇异常时的响应, 从而让用户自己可以知晓在何种情况下会存在快照创建出来, 但是实际数据却无法保障一致性.

所以其实这个问题对应的其实是快照的应用一致性, 包括文件系统内而已

> 除了虚拟硬盘上的数据之外，**文件系统一致性快照**还会记录内存和待处理I/O操作中的所有数据。在拍摄文件系统一致性快照之前，访客操作系统上的文件系统会进入静默状态，内存中的所有文件系统缓存数据和待处理I/O操作都会刷新到硬盘。

| 类型        | 说明                                                                                                                                                                                      | 实现方式                                                                                                                                      |
|-----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| 应用一致性快照   | 应用一致性快照在快照创建时刻备份内存数据及正在进行中的数据库事务，保证应用系统数据和数据库事务的一致性。通过应用一致性快照，没有数据的损坏及丢失，避免数据库启动时日志回滚，确保应用处于一致性的启动状态。<br/>应用一致性快照以标签APPConsistent:True标识。                                               | 根据操作系统类型，实现方式如下：<br/>Windows：通过卷影复制服务VSS（Volume Shadow Copy Service）实现。<br/>Linux：通过执行自定义Shell脚本（需要您根据应用自行编写脚本）实现。应用一致性的效果，由您自己编写的脚本负责保证。 |
| 文件系统一致性快照 | 如果开启应用一致性功能，但不满足相关条件，系统将会为您创建文件系统一致性快照。<br/>文件系统一致性确保在快照创建时刻同步文件系统内存和磁盘信息，冻结文件系统写操作，使得文件系统处于一致性的状态。通过文件系统一致性快照，可以避免操作系统在重启后进行chkdsk或fsck等磁盘检查修复操作。<br/>文件系统一致性快照以标签FsConsistent:True标识。 | 根据操作系统类型，实现方式如下：<br/>Windows：如果无Windows操作系统上特定应用的VSS Writer参与时，默认创建的为文件系统一致性。<br/>Linux：如果无对应的应用脚本，默认创建的为文件系统一致性。                         |


看到阿里云的描述, 基本就知道了, 也是通过由用户自身的shell脚本内的行为来完成在创建快照前内存缓存持久化到硬盘, 确保硬盘此刻是完整的. 文件系统侧则通过默认的fsfreeze等通用方案来进行持久化.

针对数据库类业务, 如果我没理解错, 其实就是根据对应的数据库开发对应的持久化方式, 完成快照的一致性保障.

> 所谓应用一致性备份，就是指除了崩溃一致性做到的云服务器所有数据在同一时间点创建备份外，还在数据备份前触发数据库提交所有事务，并刷新OS内存脏数据，保证磁盘上保存的数据库数据是一致的。

> 采用崩溃一致性的备份来恢复云服务器，在数据恢复后，由于没有保证数据库事务的一致性，通常需要依赖数据自身的保护机制做自动的日志回滚，数据才能正常启动，数据是恢复到离备份时间点最近的一个一致性状态，相比应用一致性备份的恢复，RPO（Recovery Point Objective，指的是最多可能丢失的数据的时长）会更大，RTO（Recovery Time Objective 指的是从灾难发生到整个系统恢复正常所需要的最大时长）也更长。

这里其实描述的都是快照的一致性保障. 都是由上层触发接口落盘. 

所以这段解释通了快照的一致性保障

包括快照技术所谓的静默同理.

fsfreeze这个倒是感觉有可行性, 毕竟是能感知到文件系统内的行为的.

1、一致性级别不适用，表示备份的对象不是Windows系统；

2、应用程序一致备份（Application-Consistent Backup），表示备份了内存和IO栈中数据；

3、崩溃一致备份（Crash-consistent backup），表示只备份成功了硬盘状态；


| Operation                                              | Crash-consistent | Application-consistent |
|--------------------------------------------------------|------------------|------------------------|
| Consistent point in time backup of files               | Yes              | Yes                    |
| Utilizes Volume Shadow Copy for block-level backup     | Yes              | Yes                    |
| Application consistency                                | No               | Yes                    |
| Aware of in memory and pending I/O                     | No               | Yes                    |
| Utilizes VSS writers                                   | No               | Yes                    |
| Requires no special steps for application data restore | No               | Yes                    |

# ceph rbd内的实现

ceph在16版本librbd提供了`quiesce`能力, 主要描述的就是在创建快照前和后分别提供了一个hook接口.


# Reference
1.  [通过Go SDK创建应用一致性快照](https://www.alibabacloud.com/help/zh/elastic-compute-service/latest/create-application-consistent-snapshots-by-using-ecs-sdk-for-go)
2. [云备份技术解析 （三）应用一致性备份\-云社区\-华为云](https://bbs.huaweicloud.com/blogs/100341)