---
title: 崩溃一致性初探
subtitle: tech
date: 2023-06-09 22:57:36
updated:
tags: [分布式, 一致性]
categories: [专业]
---

## 背景

主要是源自于


### 功能中所说的crash consistent, 能否保障上面的数据库或者文件系统不损坏? 只是丢了一段时间的数据呢?

数据库感觉有可行性, 那文件系统呢?

包括快照技术所谓的静默同理.

fsfreeze这个倒是感觉有可行性, 毕竟是能感知到文件系统内的行为的.

除非文件系统的损坏, 主要指代的就是上层的写入只写了一半那种, 而但凡能够保障写入的一致性, 文件系统就不会损坏. 那样的话, 倒是可以理解为没有问题.

一半这部分行为， 一半是包括上层的flush+下层的freeze, 确保不存在依旧保存在内存中的对象

那如果是走rbd的行动, 当没有文件系统, 其实是走rbd cache. 此时技术上应该是可控的?

而如果是纯操作系统层面, 那就不归存储端管控了. 所以如果是在这个盘上建的文件系统的方式, 那可能依旧无法管控到位.


通常在对数据进行备份时，存在以下三种数据保护的一致性：

1. 不一致备份（In-consistent backup），表示备份的数据是正在改变的数据；
2. 崩溃一致备份（Crash-consistent backup），表示备份的数据类似系统异常宕机时的状态；
3. 应用一致备份（Application-consistent backup），表示备份的数据是应用可用的数据；





按照社区这段当时的意思, 我觉得我可以理解了, 基本上就是通过这个写缓存, 确保即便盘丢了, 文件系统也不坏, 只是丢失一段时间写入的数据. 相当有回滚能力.

只是怎么实现的暂时还没太理解, 单纯的日志结构, 可以满足数据, 但是文件系统不损坏的flush等请求, 如何保障?如果这个rbd挂载后, 上层建了文件系统, 那样的话, 如果文件系统不下写io, 那是做不到的.

除非我对POSIX语义理解还是有问题

#### POSIX语义如何保障文件系统一定不损坏.

所以是POSIX语义来完成的这个保障吧? 当用户遵循了POSIX语义使用了fsync等接口时, 此时这个文件系统内的可靠性就得到了保障?

而如果没有使用时, 则自然就无从保障?


是否主要牵扯的是当文件系统修改元数据时, 这部分元数据一旦没能被持久化下来带来的损坏呢? 

是否可以理解为保序就可以?

但是必须得是文件系统或者数据库自身实现的

所以如果我有一个单独的缓存盘, 这个缓存盘自身是无法实现这个效果的. 

| Operation     | Crash-consistent | Application-consistent |
|---------------|------------------|------------------------|
| 备份文件的时间点是否一致  | ✔                | ✔                      |
| 利用快照进行卷级或文件备份 | ✔                | ✔                      |
| 快照时数据库或应用提前静默 | ×                | ✔                      |
| 恢复时数据是否一定正常使用 | ×                | ✔                      |


**但是这种状态有多一致呢？**

从vss参与的组件可以知道，只有文件系统本身参与了，一些应用比如SQLServer等并没有参与，所以说假设我们把快照中的数据都备份了，然后再把备份的数据都还原，SQLServer大概率是可以正常启动的，但在运气不好的时候可能是无法启动的。

我们称这种一致状态为crash-consistent状态。

Crash-consistent对于保证被保护数据尽量在同一个时间点上，已经是一种很大的进步了，但是对于最稳妥的数据保护来说这还不够，还需要支持更高级别的一致性，即应用级别的一致性，这就是application-consistent。


根据上面这段的表述, 说明这个技术确实是做不到的.

性，方式一是通过数据库或应用提供的接口或工具进行备份，方式二是调用数据库静默后进行快照，再备份快照文件。应用一致性的保证，一般都需要应用本身参与，例如备份接口或静默指令。再拿windows举例，vss可以实现上述方式二的应用一致性备份，且很简单，可以通知系统中的那些支持vss writer机制的应用比如sql，exchange等去flush数据并处于类似静默状态，使应用本身在快照时保持自己的一致状态，这样就确保了备份下来的数据一定是能够被应用正常使用的。

所以配合上述的方案, 提供对应的接口才能做到. 文件系统同理. 单纯的下层是无法满足的

所以这个情况下rbd的那个quinsce接口倒是具有对应的价值了吧.


CDM（Copy Data Management副本数据管理）是具备原生的、天然的application consistent属性。Gartner给出CDM的定义是：它从生产环境通过快照技术获取有应用一致性保证的数据，在非生产存储上生成“黄金副本”（Golden Image），这个“黄金副本”数据格式是原始的磁盘格式，可再虚拟化成多个副本直接挂载给服务器，分别用于备份恢复、容灾或开发测试。



#### 文件系统的sync , 怎么落到块上, 让块有所感知呢?
