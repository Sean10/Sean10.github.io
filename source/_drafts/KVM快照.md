---
title: KVM快照
subtitle: KVM
date: 2018-09-01 23:45:42
updated:
tags: [KVM, libvirt, 虚拟化]
categories: [专业]
---

KVM快照时间问题

snapshot-create-as             Create a snapshot from a set of args

time snapshot-create-as platform snap1 
做3份，在用压力测试软件使内存占用达到6G时,查看做快照 瓶颈
统计3次快照分别的时间，删除并重复5次，记录时间

| 序号 | 虚拟机内存占用 | 虚拟机CPU占用 | 一级快照 | 二级快照   | 三级快照   | 参数   | 版本       | 宿主机内存 |
| ---- | -------------- | ------------- | -------- | ---------- | ---------- | ------ | ---------- | ---------- |
| 1    | 6.79/16        | 0             | 44.440s  | 37.149s    | 45.999s    | null   | qemu 3.0   | 16G        |
| 2    | 6.8/16         | 3             | 37.928s  | 36.576s    | 46.927s    | null   | qemu 3.0   | 16G        |
| 3    | 6.8/10         | 3             | 36.505s  | 36.133s    | 37.288s    | --live | qemu3.0    | 16G        |
| 4    | 4.15/10        | 15            | 25.814s  | 24.067s    | 23.831s    | --live | qemu3.0    | 16G        |
| 5    | 4.82/6         | 98            | 3m2.747s | 14m25.957s | 12m38.762s | null   | qemu 1.5.3 | 8G         |
| 6    | 5.22/6         | 3             | 4m0.332s | 16m24.316s | 33m24.128s | null   | qemu 1.5.3 | 8G         |
| 7    | 4.74/6         | 90            | 4m15s    |            |            |        | qemu 3.0   | 8G         |
| 8    | 4.07/6         | 39            | 34.616s  | 32.173s    | 25.473s    | null   | qemu 3.0   | 16G        |
| 9    | .6.66/10         | 0             | 4m0.332s | 16m24.316s | 33m24.128s | cache=unsafe   | qemu 1.5.3 | 16G         |
目前测试判断宿主机剩余内存影响较大，剩余8G，创建一个快照，剩余5G，创建第二个，剩余100M.
删除第二个快照，回到5G,删除第一个快照，回到8G




目前dstat可以看到qemu3.0上

  7   5  76  13   0   0|  68k  114M|2490B 1123B|   0     0 |5430    24k
  3   3  72  22   0   0|   0   189M|1437B   43B|   0     0 |3840    16k
  3   3  73  21   0   0| 410B  194M|1479B   43B|   0     0 |3827    16k
  2   2  75  21   0   0|  26k  187M|1575B  221B|   0     0 |2908    13k

在1.5.3上
  3   2  70  25   0   0|3724k   17M| 265B   97B|   0     0 |1830  6898 
  3   2  71  24   0   0|5624k   25M| 553B  108B|   0     0 |2118  8787 
  4   2  68  26   0   0|5357k   21M| 883B   94B|   0     0 |2042  7941 
  3   2  70  24   0   0|5452k   25M| 423B   97B|   0     0 |2102  8717 
  3   2  71  23   0   0|4926k   22M| 828B  116B|   0     0 |1986  7886 
  3   2  69  25   0   0|6141k   24M| 599B  108B|   0     0 |2124  8657 
  3   2  71  24   0   0|4076k   18M| 369B   75B|   0     0 |1830  7156 
  3   2  68  26   0   0|5304k   18M| 588B  108B|   0     0 |1898  7458 
  4   2  69  24   0   0|4352k   19M| 598B  108B|   0     0 |1952  7573 

同一张系统卡更换到16G设备后，
  1   1  65  33   0   0|6963B  173M| 653B   75B|   0     0 |1596  5434 
  1   3  77  19   0   0|9830B  160M| 515B   43B|   0     0 |1801    21k
  1   0  76  23   0   0| 222k  144M| 853B 1379B|   0     0 |1804  6362

revert


根据尝试

在



目前做的内部快照 

外部快照怎么样呢

https://bugzilla.redhat.com/show_bug.cgi?id=988436



----------


# Linux内核缓存机制

## Page Cache



## Buffer Cache

# Reference
1. [理解 QEMU/KVM 和 Ceph（1）：QEMU-KVM 和 Ceph RBD 的 缓存机制总结](http://www.cnblogs.com/sammyliu/p/5066895.html)