---
title: 快照初探
subtitle: tech
date: 2023-04-16 23:05:12
updated:
tags: [快照, snap]
categories: [专业]
---


# 功能


-   **数据瞬时备份：**可创建保障数据一致性的磁盘数据快照，使RPO为0；
-   **数据快速恢复：**当出现数据灾难，通过快照点进行回退，极具降低RTO；
-   **数据分析：**将快照数据作为数据分析使用，不占用业务系统性能；
-   **应用测试：**将数据快照卷挂在给测试主机作为新应用或操作系统的测试数据，使得生产数据不受影响；

# 常见方案

SNIA 将快照的实现方式表述为：镜像分离(split mirror)、改变块(changed block)、并发(concurrent)三大类。后两种在实现时其实质就是写时复制及I/O重定向。对于 split mirror 的方式，由于其灵活性以及开销问题，在实际的存储系统中，并不实用。

## COW

### COFW (**Copy-On-First-Write**)

### 异步COW



## ROW



# 快照 消耗空间统计

有个痛点需求, 他们要做CDP, 需要识别出快照占用的空间大小


* CDP  浪潮的快照空间感知? 
* smartx 快照空间占用
* rbd空间占用
* cephfs 快照空间占用
* .snap的方案, 
* virtualbox
* qcow2 的查询实现



初步猜测, 主要是依赖文件系统在mds内存储的这种元数据.

### ceph内, 按照object-map, 通过diff快照和对象之间的object-map差异, 其实是可以快速拿到空间占用的



### virtualbox 源码

```
  361   +- Proxy.vdi             4.8G VDI  rlock   d5f84afb-0794-4952-ab71-6bbcbee07737
  362:  |  +- &lt;snapshot>        12.3G VDI  rlock     dffc67aa-3023-477f-8033-b27e3daf4f54
  363:  |  +- &lt;snapshot>         8.8G VDI  rlock       3b2755bd-5f2a-4171-98fe-647d510b6274
  364:  |  +- &lt;snapshot>        14.6G VDI  rlock         e2ccdb5f-49e8-4123-8623-c61f363cc5cf
  365:  |  +- &lt;snapshot>         7.4G VDI  wlock           3c1e6794-9091-4be3-9e80-11aba40c2649
  366  

  370   +- Oracle Linux 7.vdi     7.0G VDI created 96d2e92e-0d4e-46ab-a0f1-008fdbf997e7
  371:  | +- &lt;snapshot>          15.9G VDI created   f9cc866a-9166-42e9-a503-bbfe9b7312e8
  372   |
```


# 快照demo阅读




[LevelDB源码阅读\-\-快照snapshot \| 成长录\-知行合一](https://www.a-programmer.top/2020/04/19/LevelDB%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB--%E5%BF%AB%E7%85%A7snapshot/)