---
title: 微信聊天记录及语音导出方案实践
subtitle: tech
date: 2021-09-18 01:02:34
updated:
tags: [wechat, ffmpeg]
categories: [专业]
---

# 背景
需求是把微信多个对话里的语音全部保存下来, 保存到一个文件或者一份链接. 指向多个文件.

# 调查
## 目前主流的方案是手动点击收藏, 然后把语音转存为笔记, 然后实际就变成了一份silk文件, 在android或者在pc上就能够从目录里提取出来, 进行编码转换.
## wechatExporter导出ios设备
## wxbackup导出ios设备
## 微痕迹 app
## 微信语音导出助手 for android


# 手动导出转换语音

## 0. 进入微信聊天记录所在位置
``` bash
mkdir ~/Downloads/voice
cd ~/Library/Containers/com.tencent.xinWeChat/Data 
```


## 1. 复制出音频, 按照时间顺序重命名.
``` bash
find . -name '*.silk' | xargs -L1 -I {} cp -af {} ~/Downloads/voice/ 
cd ~/Downloads/voice/
i=1; for x in `ls -tr *.silk`; do cp -af $x "$i".silk; let i=i+1; done;
```


## 2. silk解码转换为mp3
[kn007/silk\-v3\-decoder: \[Skype Silk Codec SDK\]Decode silk v3 audio files \(like wechat amr, aud files, qq slk files\) and convert to other format \(like mp3\)\. Batch conversion support\.](https://github.com/kn007/silk-v3-decoder)

主要使用以上脚本

``` bash
sh converter.sh ~/Downloads/voice ~/Downloads/out mp3
```

### 3. 安装`ffmpeg`
```
brew install ffmpeg
```


## 4. 筛选后, 拼接mp3

生成要拼接的文件的目录.
``` bash
ls ./ | xargs -I {}  realpath {} | xargs -I {} echo "file '""{}""'" >> ~/Downloads/filelist.txt
```

使用`ffmpeg`进行拼接
``` bash
ffmpeg -f concat -safe 0 -i filelist.txt -y output.mp3
```

## 5. 校验拼接后的`mp3`长度和

``` bash
python3 xx.py ${mp3_path}

```

输出的结果和我上面拼接后的文件的长度一致, ok~没问题~

``` python
#!/bin/python3
import os
import sys
import glob
import json
import logging
import subprocess

def get_file_duration(file):
    process = subprocess.Popen("ffprobe {} -print_format json -show_format -show_streams".format(file), shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    stdout = process.communicate()[0]
    logging.debug(f"stdout: {stdout}")
    format_data = json.loads(stdout)
    duration = parse_duration(file, format_data)
    return duration
    
def parse_duration(file, data):
    format_data = data.get('format', {})
    res = float(format_data.get('duration'))
    if not res:
        res = 0
        logging.error(f"{file} cannot get duration")
    return res

def get_mp3_files(path):
    files = list(glob.glob(os.path.join(path, "*.mp3")))
    return files

def calc_duration(data_list):
    res = sum(data_list)
    return res

def main():
    logging.basicConfig(level=logging.INFO)
    result = []
    files = get_mp3_files(sys.argv[1])
    logging.debug(files)
    for file in files:
        result.append(get_file_duration(file))
    print(calc_duration(result))




main()

```

# 使用wxbackup完整导出聊天记录

## 1. 使用微信自带的迁移聊天记录功能迁移到ipad/iphone上

用`ipad/iphone`登录同一个微信账号, 需要安卓机和`ios`设备在同一个局域网(即同一`Wifi`里), 然后进入`设置 -> 聊天 -> 聊天记录备份与迁移`.

## 2. 将ipad连接到`mac`/`pc`上, 将ios设备进行整机备份
高版本`macOS`比如`10.15`是在`finder`里进行的备份, 低版本则在`itunes`中.

参照`apple`官方文档即可, [如何备份您的 iPhone、iPad 和 iPod touch \- Apple 支持 \(中国\)](https://support.apple.com/zh-cn/HT203977)

## 3. 备份后, 使用wxbackup的软件, 指定`ios`设备在`mac/pc`里的备份数据库路径

可能因为`finder`高版本导致默认打开软件时没找到备份路径, 手动指定到` ~/Library/Application Support/MobileSync/Backup`即可. 就立刻会显示出微信的聊天记录了.

不过似乎存在一个缺憾, 不能全选导出. 只能一个个选择导出? (PS.可能我一开始不点到具体的聊天记录可能就行了)

## 4. 点进各个对话目录里`index.html`查看和微信一般的`web`页面来看记录吧


# Reference
1. [Windows下批量转换Silk v3音频文件为MP3格式 \| kn007的个人博客](https://kn007.net/topics/batch-convert-silk-v3-audio-files-to-mp3-in-windows/)
2. [mryqu\.github\.io/微信语音导出和转换\.md at f48df2cb1fc0e604eca4c5452b5c7498fe5717bd · mryqu/mryqu\.github\.io](https://github.com/mryqu/mryqu.github.io/blob/f48df2cb1fc0e604eca4c5452b5c7498fe5717bd/content/post/%E5%BE%AE%E4%BF%A1%E8%AF%AD%E9%9F%B3%E5%AF%BC%E5%87%BA%E5%92%8C%E8%BD%AC%E6%8D%A2.md)
3. [关于微信语音导出，这个方法强烈建议~](https://www.yinxiang.com/everhub/note/1157fbcf-0363-4bd4-b015-e2a95aad59c3)
4. [批量导出微信语音消息为mp3并附python修改文件名脚本 \| 韶华尐沐](https://ds666.fun/2019/08/02/%E6%89%B9%E9%87%8F%E5%AF%BC%E5%87%BA%E5%BE%AE%E4%BF%A1%E8%AF%AD%E9%9F%B3%E6%B6%88%E6%81%AF%E4%B8%BAmp3%E5%B9%B6%E9%99%84python%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E5%90%8D%E8%84%9A%E6%9C%AC/)
5. [批量导出微信语音的方法（技术向） – vector090's blog](https://vector0902.ml:5444/blog/?p=2692)
6. [微信聊天记录导出方案总结](https://www.123455.xyz/2021/04/blog-post_3.html)
7. [\(1 封私信 / 20 条消息\) 如何导出微信【收藏】中的语音文件？ \- 知乎](https://www.zhihu.com/question/30112442)
8. [tsycnh/WeChatExporter: 一个可以快速导出、查看你的微信聊天记录的工具](https://github.com/tsycnh/WeChatExporter)
9. [微信聊天记录导出](http://wxbackup.imxfd.com/)
10. [Collections/GitHub 出品：一键导出解密微信聊天记录\.md at c9901d41cb43ba8cbb04d8331b853fd3da13a3bf · RobertWang/Collections](https://github.com/RobertWang/Collections/blob/c9901d41cb43ba8cbb04d8331b853fd3da13a3bf/2021/06/06/GitHub%20%E5%87%BA%E5%93%81%EF%BC%9A%E4%B8%80%E9%94%AE%E5%AF%BC%E5%87%BA%E8%A7%A3%E5%AF%86%E5%BE%AE%E4%BF%A1%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95.md)